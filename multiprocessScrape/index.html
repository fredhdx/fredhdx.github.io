<!DOCTYPE html><html class="theme-next gemini use-motion" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta name="google-site-verification" content="v0OrECtdVkj5UBsT-m2uycBhubf93gLqqP49ewDOLDI"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css"><meta name="keywords" content="web-crawl,requests,multiprocess,pool,gevent,webScrape,"><link rel="alternate" href="/atom.xml" title="A Scattered Note on Web-Dev" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2"><meta name="description" content="使用Python获取指定B站UP主所有上传视频; 使用Python自带或第三方多任务插件进行加速"><meta name="keywords" content="web-crawl,requests,multiprocess,pool,gevent,webScrape"><meta property="og:type" content="article"><meta property="og:title" content="使用Python多线程爬虫获取B站UP主视频信息"><meta property="og:url" content="https://fredhdx.github.io/multiprocessScrape/index.html"><meta property="og:site_name" content="A Scattered Note on Web-Dev"><meta property="og:description" content="使用Python获取指定B站UP主所有上传视频; 使用Python自带或第三方多任务插件进行加速"><meta property="og:locale" content="en"><meta property="og:image" content="https://fredhdx.github.io/multiprocessScrape/Comparepng.png"><meta property="og:updated_time" content="2018-03-06T22:29:47.993Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="使用Python多线程爬虫获取B站UP主视频信息"><meta name="twitter:description" content="使用Python获取指定B站UP主所有上传视频; 使用Python自带或第三方多任务插件进行加速"><meta name="twitter:image" content="https://fredhdx.github.io/multiprocessScrape/Comparepng.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.2",sidebar:{position:"left",display:"post",offset:12,offset_float:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://fredhdx.github.io/multiprocessScrape/"><title>使用Python多线程爬虫获取B站UP主视频信息 | A Scattered Note on Web-Dev</title><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-106321938-2","auto"),ga("send","pageview")</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">A Scattered Note on Web-Dev</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> Archives</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> Categories</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://fredhdx.github.io/multiprocessScrape/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="KnightR"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="A Scattered Note on Web-Dev"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">使用Python多线程爬虫获取B站UP主视频信息</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-05T00:00:00+00:00">2018-03-05</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/data/" itemprop="url" rel="index"><span itemprop="name">data</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/multiprocessScrape/#comments" itemprop="discussionUrl"><span class="post-comments-count hc-comment-count" data-xid="multiprocessScrape/" itemprop="commentsCount"></span></a></span> <span class="post-meta-divider">|</span><span class="page-pv"><i class="fa fa-file-o"></i><span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>使用Python获取指定B站UP主所有上传视频; 使用Python自带或第三方多任务插件进行加速<a id="more"></a></p><p>使用Python多线程爬虫获取B站UP主视频信息</p><p>使用Python多线程爬虫获取B站UP主视频信息</p><h1 id="目标">目标</h1><p>使用Python获取指定B站UP主所有上传视频</p><p>使用Python自带或第三方多任务插件进行加速</p><h1 id="需要的库">需要的库</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> psutil</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> cpu_count</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame</div><div class="line"><span class="keyword">import</span> gevent.monkey</div><div class="line"></div><div class="line"><span class="keyword">import</span> gevent.pool <span class="keyword">as</span> gpool</div></pre></td></tr></table></figure><h1 id="基础例子单线程">基础例子(单线程)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># UP主id: 如https://space.bilibili.com/14781644中，14781644为mid</span></div><div class="line">mid = <span class="number">14781644</span></div><div class="line"></div><div class="line"><span class="comment"># API: 此API返回json格式，含有当前页面的所有上传视频信息</span></div><div class="line">url = <span class="string">"https://space.bilibili.com/ajax/member/getSubmitVideos?mid=%s&amp;pagesize=30&amp;tid=0&amp;page=%s&amp;keyword=&amp;order=pubdate"</span> % (mid, page)</div><div class="line"></div><div class="line"><span class="comment"># 通过一次request该API，获取所有页数的url</span></div><div class="line">API_list, itemNum = getListing(mid)</div><div class="line"></div><div class="line"><span class="comment"># 循环所有页面获得每个视频的信息</span></div><div class="line">Info = []</div><div class="line"><span class="keyword">for</span> page <span class="keyword">in</span> API_list:</div><div class="line">	Info.append(get_singlePage(page))</div></pre></td></tr></table></figure><p>其中</p><p><code>getListing</code>含有一次<code>requests.get</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pageList</span><span class="params">(mid, headers)</span>:</span></div><div class="line">    <span class="string">''' input: (bilibili) mid</span></div><div class="line"><span class="string">        output: A list containing page urls for all submitted videos</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    pageSize = <span class="number">30</span></div><div class="line">    API= (<span class="string">'https://space.bilibili.com/ajax/member/getSubmitVideos?mid=%s'</span> % str(mid)</div><div class="line">            + <span class="string">'&amp;pagesize=%s'</span> % str(pageSize) + <span class="string">'&amp;tid=0&amp;page=%s&amp;keyword=&amp;order=pubdate'</span> )</div><div class="line">    pageNum = <span class="number">0</span></div><div class="line">    itemNum = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="comment"># get pageNum</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        r = requests.get((API % <span class="string">'1'</span>), headers=headers)</div><div class="line">        <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</div><div class="line">            json_content = r.json()</div><div class="line">            tlist = json_content[<span class="string">'data'</span>][<span class="string">'tlist'</span>]</div><div class="line">            <span class="keyword">for</span> tab <span class="keyword">in</span> tlist:</div><div class="line">                itemNum += int(tlist[tab][<span class="string">'count'</span>])</div><div class="line">            pageNum = int(itemNum/pageSize) + (itemNum % pageSize &gt; <span class="number">0</span>)</div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        print(e)</div><div class="line">        sys.exit</div><div class="line"></div><div class="line">    <span class="comment"># get page list</span></div><div class="line">    API_list = [(API % str(page)) <span class="keyword">for</span> page <span class="keyword">in</span> range(<span class="number">1</span>, pageNum + <span class="number">1</span>)]</div><div class="line">    <span class="keyword">return</span> [API_list, itemNum]</div></pre></td></tr></table></figure><p><code>get_singlePage</code>含有一次<code>requests.get</code>, 返回<code>{&quot;视频名字&quot;, &quot;aid&quot;, &quot;url&quot;}</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_singlePage</span><span class="params">(params)</span>:</span></div><div class="line"></div><div class="line">    page_url, headers = params</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        r = requests.get(page_url, headers=headers)</div><div class="line">        json_content = r.json()</div><div class="line">        vlist = json_content[<span class="string">'data'</span>][<span class="string">'vlist'</span>]</div><div class="line">        records = []</div><div class="line">        <span class="keyword">for</span> video <span class="keyword">in</span> vlist:</div><div class="line">            records.append(json_video(video)) <span class="comment"># json_video用于提取一个json object中的信息</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        print(e)</div><div class="line">        sys.exit</div><div class="line"></div><div class="line">    <span class="keyword">return</span> records</div></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 视频数量 花费时间</div><div class="line">100 took 5.667012453079224 seconds</div><div class="line">200 took 14.260912895202637 seconds</div><div class="line">300 took 17.25295925140381 seconds</div><div class="line">700 took 26.95353651046753 seconds</div><div class="line">1500 took 51.36556887626648 seconds</div><div class="line">3000 took 108.84225630760193 seconds</div></pre></td></tr></table></figure><p><strong>在基础例子中，我们一共需要进行（视频数量/30）次requests。</strong>因此，如果UP主所上传的视频数目过多，进行一次爬虫会花去数分钟时间，这对需要重复爬取的用户非常不利。</p><h1 id="多任务">多任务</h1><p>幸好，Python和其他第三方为我们提供了不少用于多任务计算的库：有Python自带的<code>multiprocessing</code>，有由<code>gevent</code>提供的<code>gevent.pool</code>，还有用于提供同一链接persistent link的<code>requests.session</code>功能。</p><p>以下，我将用以上提及的不同库对基础例子进行优化，并进行比较。</p><p>用于计算时间和作图的代码由<a href="http://maxmelnick.com/2016/04/18/faster-python-data-scraping.html" target="_blank" rel="noopener">此博客</a>提供。</p><p>首先，做好一个<code>simulateCrawlMember</code>方程用于使用不同的爬虫方程对多个拥有不同视频数量的用户进行爬取。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">simulateCrawlMember</span><span class="params">(my_func, method_name, headers)</span>:</span></div><div class="line"></div><div class="line">    mid_bucket = [<span class="number">17221410</span>, <span class="number">2139573</span>, <span class="number">37694382</span>, <span class="number">26810901</span>, <span class="number">26480852</span>, <span class="number">1315101</span>]</div><div class="line"></div><div class="line">    times = []</div><div class="line">    <span class="keyword">for</span> mid <span class="keyword">in</span> mid_bucket:</div><div class="line">        [API_list, itemNum] = get_pageList(mid, headers)</div><div class="line">        secs = my_func(API_list, <span class="number">10</span>, headers)[<span class="number">1</span>]</div><div class="line">        times.append(&#123;<span class="string">'method'</span>: method_name, <span class="string">'N'</span>: itemNum, <span class="string">'seconds'</span>: secs&#125;)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> times</div></pre></td></tr></table></figure><p>然后，借鉴<a href="http://maxmelnick.com/2016/04/18/faster-python-data-scraping.html" target="_blank" rel="noopener">此博客</a>的画图方程，用于比较不同爬虫方法的速度。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">plotPerformance</span><span class="params">(performance_results)</span>:</span></div><div class="line">    df = DataFrame(performance_results)</div><div class="line"></div><div class="line">    g = sns.factorplot(x=<span class="string">'N'</span>, y=<span class="string">'seconds'</span>, hue=<span class="string">'method'</span>,</div><div class="line">                   data=df, size=<span class="number">7</span>, ci=<span class="keyword">None</span>)</div><div class="line"></div><div class="line">    g.set_axis_labels(<span class="string">'N (# http requests)'</span>, <span class="string">'Total Time to Complete (seconds)'</span>)</div><div class="line">    plt.title(<span class="string">'Performance of different http request methods vs. number of http requests'</span>)</div></pre></td></tr></table></figure><p>接着，借鉴<a href="http://maxmelnick.com/2016/04/18/faster-python-data-scraping.html" target="_blank" rel="noopener">此博客</a>的计时方程，用于计算每一个爬虫方程的速度。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">timefunc</span><span class="params">(f)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">    Time profiling function adapted from "Simple Timers" example at</span></div><div class="line"><span class="string">    https://zapier.com/engineering/profiling-python-boss/</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">f_timer</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        start = time.time()</div><div class="line">        result = f(*args, **kwargs)</div><div class="line">        end = time.time()</div><div class="line">        elapsed_time = end - start</div><div class="line">        <span class="keyword">print</span> f.__name__, <span class="string">'took'</span>, elapsed_time, <span class="string">'seconds'</span></div><div class="line">        <span class="keyword">return</span> (result, elapsed_time)</div><div class="line">    <span class="keyword">return</span> f_timer</div></pre></td></tr></table></figure><p>合起来，我们的测试方程像这样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">sns.set_style(<span class="string">'whitegrid'</span>)</div><div class="line"></div><div class="line">performance_results = []</div><div class="line">headers = &#123;<span class="string">'user-agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36'</span>&#125;</div><div class="line"></div><div class="line">performance_results += simulateCrawlMember(parseAll_gevent, <span class="string">'gevent'</span>, headers)</div><div class="line">plotPerformance(performance_results, <span class="string">'gevent'</span>)</div><div class="line"></div><div class="line">performance_results += simulateCrawlMember(parseAll_pool, <span class="string">'pool'</span>, headers)</div><div class="line">plotPerformance(performance_results, <span class="string">'pool'</span>)</div><div class="line"></div><div class="line">performance_results += simulateCrawlMember(parseAll_gevent_session, <span class="string">'gevent + Session'</span>, headers)</div><div class="line">plotPerformance(performance_results, <span class="string">'gevent + Session'</span>)</div><div class="line"></div><div class="line">performance_results += simulateCrawlMember(parseAll_pool_session, <span class="string">'pool + Session'</span>, headers)</div><div class="line">plotPerformance(performance_results, <span class="string">'pool + Session'</span>)</div><div class="line"></div><div class="line">performance_results += simulateCrawlMember(parseAll_single, <span class="string">'Single'</span>, headers)</div><div class="line">plotPerformance(performance_results,<span class="string">'Single'</span> )</div></pre></td></tr></table></figure><h2 id="单程">单程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@timefunc</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseAll_single</span><span class="params">(API_list, numProcess, headers)</span>:</span></div><div class="line">    <span class="comment"># numProcess is dummy</span></div><div class="line"></div><div class="line">    result = []</div><div class="line">    <span class="keyword">for</span> API_url <span class="keyword">in</span> API_list:</div><div class="line">        result.append(get_singlePage((API_url, headers)))</div></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parseAll_single took 5.729526519775391 seconds</div><div class="line">parseAll_single took 14.209691286087036 seconds</div><div class="line">parseAll_single took 17.519840240478516 seconds</div><div class="line">parseAll_single took 27.10710334777832 seconds</div><div class="line">parseAll_single took 52.06931471824646 seconds</div><div class="line">parseAll_single took 110.40392351150513 seconds</div></pre></td></tr></table></figure><h2 id="使用multiprocessing库">使用multiprocessing库</h2><p><code>multiprocessing</code> 是python自带的多进程库。<code>multiprocessing</code>侧重多CPU分配，将任务分配给不同的CPU和进程用以提高处理效率。在本文的应用时，<code>multiprocessing</code>建立多个进程用以同时处理不同的<code>requests</code>访问要求。更多<code>multiprocessing</code>问题，请访问<a href="https://docs.python.org/3.6/library/multiprocessing.html" target="_blank" rel="noopener">Python文档</a> 。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@timefunc</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseAll_pool</span><span class="params">(API_list, numProcess, headers)</span>:</span></div><div class="line">    <span class="keyword">with</span> multiprocessing.Pool(numProcess) <span class="keyword">as</span> p:</div><div class="line">        result = p.map(get_singlePage, zip(API_list, [headers] * len(API_list)))</div></pre></td></tr></table></figure><blockquote><p>在单个requests方程拥有多个输入量时，需使用iterable，可通过zip()实现</p></blockquote><p>执行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parseAll_pool took 5.815796136856079 seconds</div><div class="line">parseAll_pool took 9.356193780899048 seconds</div><div class="line">parseAll_pool took 9.501183986663818 seconds</div><div class="line">parseAll_pool took 9.569898843765259 seconds</div><div class="line">parseAll_pool took 13.018352508544922 seconds</div><div class="line">parseAll_pool took 18.32560443878174 seconds</div></pre></td></tr></table></figure><h2 id="使用multiprocessing-session库">使用multiprocessing + session库</h2><p><code>requests.session()</code>使用<code>urllib3</code>的connection pooling，让用户在访问同一网址时，可以使用统一的变量和cookie。同时，<code>requests.session()</code>让重复访问的<code>TCP</code>链接被重复利用，大幅提高访问速度。</p><p>在我们的例子中，我们虽然不会重复访问同一个网址，但这些网址处于同一个域名下，所以我想测试以下<code>session</code>是否仍然能够提供一定的加速。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@timefunc</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseAll_pool_session</span><span class="params">(API_list, numProcess, headers)</span>:</span></div><div class="line">    s = requests.session()</div><div class="line">    s.headers.update(headers)</div><div class="line">    <span class="keyword">with</span> multiprocessing.Pool(numProcess) <span class="keyword">as</span> p:</div><div class="line">        result = p.map(get_singlePage_session, zip(API_list, [s] * len(API_list)))</div><div class="line"></div><div class="line">    s.close()</div></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parseAll_pool_session took 5.774076223373413 seconds</div><div class="line">parseAll_pool_session took 9.44986343383789 seconds</div><div class="line">parseAll_pool_session took 8.862924575805664 seconds</div><div class="line">parseAll_pool_session took 10.02916932106018 seconds</div><div class="line">parseAll_pool_session took 12.375799655914307 seconds</div><div class="line">parseAll_pool_session took 18.021499633789062 seconds</div></pre></td></tr></table></figure><h2 id="使用gevent库">使用gevent库</h2><blockquote><p>gevent is a <a href="https://en.wikipedia.org/wiki/Coroutine" target="_blank" rel="noopener">coroutine</a> -based <a href="http://python.org/" target="_blank" rel="noopener">Python</a> networking library that uses <a href="https://greenlet.readthedocs.io/" target="_blank" rel="noopener">greenlet</a> to provide a high-level synchronous API on top of the libev event loop. - Documentation</p></blockquote><p><code>gevent</code>是一个第三方<strong>协程</strong>资源库，可通过<code>pip install gevent</code>进行安装。协程不等于进程，协程不拥有独立独立的内存空间，占有资源小。协程共享堆，不共享栈，由程序员在协程的代码里显示调度；同时，多采用异步的消息通讯，效率比较高。更多进程和协程信息，请访问<a href="https://www.jianshu.com/p/c6053a4c3dd5" target="_blank" rel="noopener">这篇博文</a>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@timefunc</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseAll_gevent</span><span class="params">(API_list, numProcess, headers)</span>:</span></div><div class="line">    gevent.monkey.patch_socket()</div><div class="line">    pool = gpool.Pool(numProcess)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(API_list)):</div><div class="line">        pool.spawn(get_singlePage, (API_list[i], headers))</div><div class="line"></div><div class="line">    pool.join()</div></pre></td></tr></table></figure><blockquote><p>每个线程（进程）循环按照指定的任务清单顺序完成不同的任务（当任务被堵塞时，执行下一个任务；当恢复时，再回来执行这个任务；任务间切换只需要保存任务的上下文，没有内核的开销，可以不加锁的访问全局变量）</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parseAll_gevent took 5.389847040176392 seconds</div><div class="line">parseAll_gevent took 12.893646955490112 seconds</div><div class="line">parseAll_gevent took 16.130355834960938 seconds</div><div class="line">parseAll_gevent took 25.19377088546753 seconds</div><div class="line">parseAll_gevent took 50.55870485305786 seconds</div><div class="line">parseAll_gevent took 107.25761365890503 seconds</div></pre></td></tr></table></figure><h2 id="使用gevent库-session库">使用gevent库 + session库</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@timefunc</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseAll_gevent_session</span><span class="params">(API_list, numProcess, headers)</span>:</span></div><div class="line">    gevent.monkey.patch_socket()</div><div class="line">    pool = gpool.Pool(numProcess)</div><div class="line"></div><div class="line">    s = requests.session()</div><div class="line">    s.headers.update(headers)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(API_list)):</div><div class="line">        pool.spawn(get_singlePage_session, (API_list[i], s))</div><div class="line"></div><div class="line">    pool.join()</div><div class="line"></div><div class="line">    s.close()</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parse_gevent took 1.3498566150665283 seconds</div><div class="line">parse_gevent took 2.1473851203918457 seconds</div><div class="line">parse_gevent took 2.217400550842285 seconds</div><div class="line">parse_gevent took 3.378615617752075 seconds</div><div class="line">parse_gevent took 6.412792682647705 seconds</div><div class="line">parse_gevent took 12.337404251098633 seconds</div></pre></td></tr></table></figure><p>需要注意的是，使用<code>gevent</code>需要先进行<code>monkey.patch_all()</code>。</p><p>gevent和python自带的socket库有部分的兼容问题，因此gevent提供了自己的socket补丁<code>monkey.patch_all()</code>。需要在import之后立刻进行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import gevent.pool as pool</div><div class="line">import gevent.monkey</div><div class="line"></div><div class="line">monkey.patch_all()</div></pre></td></tr></table></figure><blockquote><p>在进行monkey.patch_all()之后，multiprocessing()等使用默认socket库的程序会出现错误。有一些错误可以通过<code>monkey.patch_all(thread=False, socket=False)</code>解决，有一些不行。因此，尽量把gevent的使用放在代码末尾，或者避免和multiprocessing等同时使用。gevent自带的threading功能足够满足多线程需求。</p></blockquote><p>如果未进行monkey补丁，在同时使用<code>gevent</code>和<code>requests.session</code>则可能出现以下错误。该错误为多次重复服务器拒绝连接，是由<code>gevent</code>和默认<code>socket</code>冲突导致。。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">HTTPSConnectionPool(host=<span class="string">'space.bilibili.com'</span>, port=443): Max retries exceeded with url: /ajax/member/getSubmitVideos?mid=1315101&amp;pagesize=30&amp;tid=0&amp;page=2&amp;keyword=&amp;order=pubdate (Caused by SSLError(SSLError(<span class="string">"bad handshake: SysCallError(-1, 'Unexpected EOF')"</span>,),))</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"C:\Users\Dongxu\AppData\Local\Programs\Python\Python36\lib\site-packages\gevent\greenlet.py"</span>, line 536, <span class="keyword">in</span> run</div><div class="line">    result = self._run(*self.args, **self.kwargs)</div><div class="line">  File <span class="string">"C:\Users\Dongxu\Documents\getVideo_biliMember.py"</span>, line 106, <span class="keyword">in</span> get_singlePage_session</div><div class="line">    <span class="built_in">return</span> records</div><div class="line">UnboundLocalError: <span class="built_in">local</span> variable <span class="string">'records'</span> referenced before assignment</div><div class="line">Mon Mar  5 04:08:28 2018 &lt;Greenlet at 0x20162abe470: get_singlePage_session((<span class="string">'https://space.bilibili.com/ajax/member/getSubmit)&gt; failed with UnboundLocalError</span></div></pre></td></tr></table></figure><h2 id="使用grequests库有误">使用grequests库(有误)</h2><p><code>grequests</code>是由<a href="https://github.com/kennethreitz" target="_blank" rel="noopener">kennethreitz</a>开发的第三方库。grequests同时使用requests和gevent，允许用户发起多个异步HTTP请求。<code>grequests</code>简化了单独使用<code>gevent</code>的步骤，并且在进行HTTP请求时有一定速度上的提升。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exception_handler</span><span class="params">(request, exception)</span>:</span></div><div class="line">    print(<span class="string">"Request failed"</span>)</div><div class="line"></div><div class="line"><span class="meta">@timefunc</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseAll_grequests</span><span class="params">(API_List, numProcess, headers)</span>:</span></div><div class="line">    <span class="keyword">import</span> grequests</div><div class="line"></div><div class="line">    s = requests.Session()</div><div class="line"></div><div class="line">    rs = (grequests.get(u, session=s) <span class="keyword">for</span> u <span class="keyword">in</span> API_List)</div><div class="line">    responses = grequests.map(rs, exception_handler=exception_handler)</div><div class="line">    all_records = []</div><div class="line"></div><div class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> responses:</div><div class="line">        <span class="keyword">if</span> r:</div><div class="line">            <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</div><div class="line">                json_content = r.json()</div><div class="line">                vlist = json_content[<span class="string">'data'</span>][<span class="string">'vlist'</span>]</div><div class="line">                records = []</div><div class="line">                <span class="keyword">for</span> video <span class="keyword">in</span> vlist:</div><div class="line">                    records.append(json_video(video))</div><div class="line">                all_records += records</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                print(r.status_code)</div></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parse_gevent_session took 1.0508449077606201 seconds</div><div class="line">parse_gevent_session took 1.8688721656799316 seconds</div><div class="line">parse_gevent_session took 1.7941479682922363 seconds</div><div class="line">parse_gevent_session took 2.61824893951416 seconds</div><div class="line">parse_gevent_session took 4.60194730758667 seconds</div><div class="line">parse_gevent_session took 8.719105005264282 seconds</div></pre></td></tr></table></figure><p>使用<code>grequests</code>依然会导致response错误，无论是否使用<code>session</code>。所以，<code>gevent</code>应该共享了一些HTTP链接数据导致B站将不同的requests视作爬虫处理。</p><blockquote><p>关于更多的grequests: <a href="https://stackoverflow.com/questions/23935201/is-a-python-requests-session-object-shared-between-gevent-greenlets-thread-safe" target="_blank" rel="noopener">thread</a>, <a href="https://github.com/kennethreitz/grequests" target="_blank" rel="noopener">doc</a></p></blockquote><h1 id="结果分析">结果分析</h1> <img src="/multiprocessScrape/Comparepng.png" title="Benchmark"><blockquote><p>其中，N为UP主视频数量，实际执行的<code>requests.get</code>访问数大概为N/30。</p></blockquote><table><thead><tr class="header"><th>视频数</th><th align="center">单线程</th><th align="center">pool</th><th align="center">pool + session</th><th align="center">gevent</th><th align="center">gevent + session</th></tr></thead><tbody><tr class="odd"><td>156</td><td align="center">5.773</td><td align="center">7.83</td><td align="center">7.241</td><td align="center">1.349</td><td align="center">1.05</td></tr><tr class="even"><td>413</td><td align="center">13.88</td><td align="center">8.68</td><td align="center">8.60</td><td align="center">2.147</td><td align="center">1.86</td></tr><tr class="odd"><td>522</td><td align="center">17.38</td><td align="center">8.231</td><td align="center">8.86</td><td align="center">2.217</td><td align="center">1.79</td></tr><tr class="even"><td>792</td><td align="center">27.37</td><td align="center">9.473</td><td align="center">9.29</td><td align="center">3.378</td><td align="center">2.618</td></tr><tr class="odd"><td>1569</td><td align="center">51.51</td><td align="center">12.42</td><td align="center">12.07</td><td align="center">6.412</td><td align="center">4.60</td></tr><tr class="even"><td>3259</td><td align="center">113.71</td><td align="center">18.34</td><td align="center">18.33</td><td align="center">12.33</td><td align="center">8.71</td></tr></tbody></table><h2 id="gevent速度最快">gevent速度最快</h2><p>在仅仅使用10个gevent携程时，<code>gevent</code>所达到的速度也比<code>multiprocessing</code>快上一倍左右。由此可以看出，在进行大量socket连接时，<code>gevent</code>这个针对网络连接优化过的多“线程”库比多进程更加高效。而在资源占用率上，<code>gevent</code>因为不产生新的进程，对于机器基本不产生额外的负担。在我的台式机上，可以轻易的使用上百条携程。</p><h2 id="multiprocessing优化明显但资源占用率太大">multiprocessing优化明显，但资源占用率太大</h2><p><code>multiprocessing.pool</code>对于我们的应用的加速也很明显。共享<code>session</code>的使用在使用<code>multiprocessing</code>时并没有明显的加速。然而，使用<code>multiprocessing</code>时CPU占用率达到了100%，对于需要计算机同时处理其它工作显然时不合适的。可以考虑减少进程数，或者使用<code>psutils</code>来限制进程的优先度。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> psutil</div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool, cpu_count</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">limit_cpu</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"is called at every process start"</span></div><div class="line">    p = psutil.Process(os.getpid())</div><div class="line">    <span class="comment"># set to lowest priority, this is windows only, on Unix use ps.nice(19)</span></div><div class="line">    p.nice(psutil.BELOW_NORMAL_PRIORITY_CLASS)</div><div class="line"></div><div class="line"><span class="comment"># 使用pool时</span></div><div class="line">pool = Pool(<span class="keyword">None</span>, limit_cpu) <span class="comment"># 使用CPU核心数目，也可以自定义</span></div></pre></td></tr></table></figure><p>执行结果</p><table><thead><tr class="header"><th align="center"></th><th align="center">psutil</th><th align="center">2 Process</th><th align="center">4 Process</th><th align="center">10 Process</th><th align="center">单线程</th></tr></thead><tbody><tr class="odd"><td align="center">3259视频</td><td align="center">31.91</td><td align="center">60.75</td><td align="center">32.19</td><td align="center">18.32</td><td align="center">110.41</td></tr><tr class="even"><td align="center">CPU</td><td align="center">浮动</td><td align="center">小于50%</td><td align="center">浮动</td><td align="center">100%</td><td align="center">&lt;10%</td></tr></tbody></table><h2 id="requests.session优化作用不明显">requests.session优化作用不明显</h2><p>无论在使用<code>gevent</code>还是<code>multiprocessing</code>时，加上<code>requests.session</code>后的优化都不明显。原因可能是因为我们的并没有重复连接同一url。不过在访问大量连接时，<code>session</code>对于<code>gevent</code>有小程度的优化。可以预则，如果继续加大需要访问的连接量，<code>session</code>加速会更加明显。</p><h1 id="参考">参考</h1><p><a href="http://maxmelnick.com/2016/04/18/faster-python-data-scraping.html" target="_blank" rel="noopener">Faster Python Data Scraping with gevent.pool</a></p><p><a href="http://blog.adnansiddiqi.me/how-to-speed-up-your-python-web-scraper-by-using-multiprocessing/" target="_blank" rel="noopener">How to speed up your python web scraper by using multiprocessing</a></p><p><a href="https://stackoverflow.com/questions/42103367/limit-total-cpu-usage-in-python-multiprocessing" target="_blank" rel="noopener">Limit total CPU usage in python multiprocessing</a></p><p><a href="https://stackoverflow.com/questions/23935201/is-a-python-requests-session-object-shared-between-gevent-greenlets-thread-safe" target="_blank" rel="noopener">Is a Python requests Session object shared between gevent greenlets, thread-safe (between greenlets)?</a></p><p><a href="https://stackoverflow.com/questions/13490346/python-gevent-pass-multiple-arguments-to-function-called-via-pool-map" target="_blank" rel="noopener">Python gevent: pass multiple arguments to function called via pool.map</a></p><p><a href="https://www.jianshu.com/p/c6053a4c3dd5" target="_blank" rel="noopener">Gevent 进程 线程 协程 异步</a></p><p><a href="http://www.gevent.org/gevent.pool.html" target="_blank" rel="noopener">gevent-pool</a></p><p><a href="https://stackoverflow.com/questions/8678307/gevent-monkeypatching-breaking-multiprocessing" target="_blank" rel="noopener">Gevent monkeypatching breaking multiprocessing</a></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>Post author:</strong> KnightR</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://fredhdx.github.io/multiprocessScrape/" title="使用Python多线程爬虫获取B站UP主视频信息">https://fredhdx.github.io/multiprocessScrape/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/web-crawl/" rel="tag"># web-crawl</a> <a href="/tags/requests/" rel="tag"># requests</a> <a href="/tags/multiprocess/" rel="tag"># multiprocess</a> <a href="/tags/pool/" rel="tag"># pool</a> <a href="/tags/gevent/" rel="tag"># gevent</a> <a href="/tags/webScrape/" rel="tag"># webScrape</a></div><div class="post-widgets"><div class="wp_rating"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/lightworksOnubuntu/" rel="next" title="Lightworks 14 Closes Immediately After Opening Ubuntu 17"><i class="fa fa-chevron-left"></i> Lightworks 14 Closes Immediately After Opening Ubuntu 17</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="hypercomments_widget"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview"> Overview</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="KnightR"><p class="site-author-name" itemprop="name">KnightR</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">42</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/fredhdx" target="_blank" title="GitHub"><i class="fa fa-fw fa-globe"></i> GitHub</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目标"><span class="nav-number">1.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#需要的库"><span class="nav-number">2.</span> <span class="nav-text">需要的库</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基础例子单线程"><span class="nav-number">3.</span> <span class="nav-text">基础例子(单线程)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#多任务"><span class="nav-number">4.</span> <span class="nav-text">多任务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#单程"><span class="nav-number">4.1.</span> <span class="nav-text">单程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用multiprocessing库"><span class="nav-number">4.2.</span> <span class="nav-text">使用multiprocessing库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用multiprocessing-session库"><span class="nav-number">4.3.</span> <span class="nav-text">使用multiprocessing + session库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用gevent库"><span class="nav-number">4.4.</span> <span class="nav-text">使用gevent库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用gevent库-session库"><span class="nav-number">4.5.</span> <span class="nav-text">使用gevent库 + session库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用grequests库有误"><span class="nav-number">4.6.</span> <span class="nav-text">使用grequests库(有误)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结果分析"><span class="nav-number">5.</span> <span class="nav-text">结果分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#gevent速度最快"><span class="nav-number">5.1.</span> <span class="nav-text">gevent速度最快</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#multiprocessing优化明显但资源占用率太大"><span class="nav-number">5.2.</span> <span class="nav-text">multiprocessing优化明显，但资源占用率太大</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#requests.session优化作用不明显"><span class="nav-number">5.3.</span> <span class="nav-text">requests.session优化作用不明显</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">KnightR</span></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script><script type="text/javascript">_hcwp=window._hcwp||[],_hcwp.push({widget:"Bloggerstream",widget_id:97727,selector:".hc-comment-count",label:"{%COUNT%}"}),_hcwp.push({widget:"Stream",widget_id:97727,xid:"multiprocessScrape/"}),function(){if(!("HC_LOAD_INIT"in window)){HC_LOAD_INIT=!0;var e=(navigator.language||navigator.systemLanguage||navigator.userLanguage||"en").substr(0,2).toLowerCase(),t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https":"http")+"://w.hypercomments.com/widget/hc/97727/"+e+"/widget.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(t,a.nextSibling)}}()</script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script type="text/javascript">wpac_init=window.wpac_init||[],wpac_init.push({widget:"Rating",id:7999,el:"wpac-rating",color:"fc6423"}),function(){if(!("WIDGETPACK_LOADED"in window)){WIDGETPACK_LOADED=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//embed.widgetpack.com/widget.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t.nextSibling)}}()</script></body></html>